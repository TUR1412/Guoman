# 变更提案: Quark R11 · 深度递归进化（视觉系统 + 质量门禁）

## 需求背景

国漫世界（Guoman World）已具备较完整的功能矩阵与较高的工程质量（静态部署、测试、Storybook、性能预算等）。当前阶段的主要瓶颈不再是“能不能实现功能”，而是：

1. **视觉系统的可持续迭代成本**：设计 tokens、全局样式与组件实现之间存在扩展边界，需要进一步“原子化 + 组件化 + 规范化”，避免新增需求导致全局样式膨胀与局部不一致。
2. **质量门禁不统一**：`npm run check` 已覆盖格式化、lint、测试、构建与 bundle budget，但覆盖率门禁仍存在落差（`npm run test:coverage` 未达阈值），导致“看似通过、深层回归风险仍在”。
3. **依赖升级窗口已到**：核心依赖出现大版本迭代（React / Vite / Vitest / Storybook / framer-motion / react-router-dom 等），需要制定“分批升级”的架构策略与回归门禁，避免一次性升级引入不可控风险。

本提案的目标是在不破坏现有体验的前提下，推进“视觉革命（最高优先级）”与“工程/质量门禁统一”，为后续更激进的依赖升级与架构拆分提供稳定基础。

## 产品分析

### 目标用户与场景

- **用户群体:** 国漫爱好者、追更党、收藏党、在移动端高频浏览的轻量用户；以及会在桌面端进行深度检索、整理收藏、制作海报的重度用户。
- **使用场景:**
  - 首页浏览/探索：快速进入分类、榜单、推荐、新闻等内容流。
  - 深度检索：关键词、筛选、排序、多维过滤。
  - 收藏与追更：收藏分组、拖拽整理、最近浏览、追更状态。
  - 成就系统与足迹：反馈与激励闭环。
  - 海报工坊：一键生成与分享可视化内容。
- **核心痛点:**
  - 视觉一致性与可读性在不同页面/组件之间存在“边缘偏差”。
  - 交互反馈（hover/active/focus/加载/错误）在极端状态下仍可能不够“可感知、可解释”。
  - 质量门禁不完整导致回归风险与迭代成本上升。

### 价值主张与成功指标

- **价值主张:** “国风墨韵 × 极光光晕”的统一视觉语言 + 可靠的交互反馈 + 可持续的工程与质量门禁。
- **成功指标:**
  - 视觉一致性：核心组件在全站复用且无明显样式分叉；主题 tokens 作为 SSOT 被落实到组件与样式实现。
  - 质量门禁：`npm run check` 与 `npm run test:coverage` 均通过；覆盖率阈值达标，减少回归风险。
  - 性能基线：继续满足 bundle budget；关键页面交互保持流畅（避免无意义重渲染与主线程阻塞）。
  - 可维护性：超大文件逐步拆解，降低单文件认知负担与变更冲突率。

### 人文关怀

- 强化可访问性（可读性/对比度/键盘可达/减少动画偏好），减少“只为炫而炫”的动效，确保对眩晕敏感用户友好。
- 所有离线/本地数据能力（收藏、足迹、成就等）优先“用户可控与可迁移”，避免锁死数据。

## 变更内容

1. **质量门禁统一:** 修复覆盖率阈值未达标问题，补齐关键工具模块与组件的测试覆盖。
2. **视觉系统深化（最高优先级）:** 以设计 tokens 为核心，强化可复用 UI 组件能力（变体、状态、语义化），把“视觉语言”从全局样式推进到组件 API。
3. **架构可维护性提升:** 对超大组件进行结构化拆分（保持行为不变前提下），降低耦合与认知负担。
4. **依赖升级策略落地:** 制定分批升级路线与回归门禁，避免一次性升级造成大范围不确定性。

## 影响范围

- **模块:**
  - `src/ui/`（组件库与设计系统桥接）
  - `src/assets/styles/`（tokens 与全局样式治理）
  - `src/components/`、`src/pages/`（大组件拆分与一致性接入）
  - `src/utils/`（覆盖率与可靠性提升）
  - `docs/` 与 `README.md`（产品说明书与架构/设计系统文档）
- **文件:** 预计涉及多文件改动（新增测试文件、拆分组件、补齐文档）。
- **API:** 无对外服务端 API；前端内部模块 API 会有小范围调整（以保持兼容为原则）。
- **数据:** 本地存储结构保持兼容；如有调整必须提供迁移/回退策略。

## 核心场景

### 需求: 覆盖率门禁达标

**模块:** 测试与工程
补齐关键模块与关键交互的覆盖率，确保覆盖率阈值可稳定通过，降低回归风险。

#### 场景: CI/本地执行覆盖率

在本地与 CI 执行 `npm run test:coverage` 时：

- 覆盖率阈值达标并稳定通过
- 覆盖率失败时能清晰定位到具体模块与缺口

### 需求: 视觉系统可复用与一致

**模块:** 设计系统 / UI组件库
把 tokens 从“全局样式定义”推进到“组件可复用能力”，保证跨页面的一致体验。

#### 场景: 通用组件状态一致

在 Card/Dialog/Button 等基础组件中：

- hover/active/focus/disabled/loading/error 状态具备一致的视觉语言
- 在 `prefers-reduced-motion` 下自动降级动画

### 需求: 大组件可维护性提升

**模块:** 页面与复杂组件
对超大文件进行结构拆分，保持行为一致并减少改动冲突。

#### 场景: AnimeDetail 可拆分而不破坏功能

拆分后：

- 页面渲染、交互、收藏/推荐/导航等行为保持一致
- 关键逻辑可被更细粒度测试覆盖

## 风险评估

- **风险:** 依赖升级引入破坏性变更（React/Router/Storybook/Vite 等）
  - **缓解:** 分批升级 + 每批次回归门禁（lint/test/build/budget/coverage）+ 逐步迁移（保留兼容层）
- **风险:** 视觉系统改动导致回归（主题/对比度/布局细节）
  - **缓解:** Storybook 作为视觉回归基线；对关键组件补齐交互测试与语义检查
- **风险:** 本地数据结构调整导致用户数据丢失
  - **缓解:** 必须提供向后兼容与迁移策略，保持导出/恢复链路可用
